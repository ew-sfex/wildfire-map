<!DOCTYPE html>
<html>

<head>
    <title>Wildfires in California</title>
    <!-- 
    SECURITY NOTE: Google Maps API key should be restricted in Google Cloud Console:
    1. Go to console.cloud.google.com/apis/credentials
    2. Find this API key (AIzaSyBx-VcDFwhH3b7obq3aAnj1m8874HQ3vgM)
    3. Under "Application restrictions" select "HTTP referrers"
    4. Add: *.sfexaminer.com/* and www.sfexaminer.com/*
    5. Under "API restrictions" select "Restrict key" and enable only:
       - Maps JavaScript API
    This prevents unauthorized usage and protects against billing abuse.
    -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBx-VcDFwhH3b7obq3aAnj1m8874HQ3vgM&callback=initMap" async defer></script>
    <style>
        /* Set the size of the map */
        #map {
            height: 600px;
            width: 100%;
        }

        /* Hide the close button for the onhover InfoWindow */
        .no-close .gm-ui-hover-effect {
            display: none !important;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        function initMap() {
            const isMobile = window.innerWidth <= 480;

            const map = new google.maps.Map(document.getElementById('map'), {
                zoom: isMobile ? 5 : 6, // Adjust zoom for mobile
                center: {
                    lat: 36.7783,
                    lng: -119.4179
                },
                styles: [
                    {
                        "elementType": "geometry",
                        "stylers": [
                            {
                                "color": "#1d2c4d"
                            }
                        ]
                    },
                    {
                        "elementType": "labels.text.fill",
                        "stylers": [
                            {
                                "color": "#8ec3b9"
                            }
                        ]
                    },
                    {
                        "elementType": "labels.text.stroke",
                        "stylers": [
                            {
                                "color": "#1a3646"
                            }
                        ]
                    },
                    {
                        "featureType": "administrative.country",
                        "elementType": "geometry.stroke",
                        "stylers": [
                            {
                                "color": "#4b6878"
                            }
                        ]
                    },
                    {
                        "featureType": "administrative.land_parcel",
                        "elementType": "labels.text.fill",
                        "stylers": [
                            {
                                "color": "#64779e"
                            }
                        ]
                    },
                    {
                        "featureType": "administrative.province",
                        "elementType": "geometry.stroke",
                        "stylers": [
                            {
                                "color": "#4b6878"
                            }
                        ]
                    },
                    {
                        "featureType": "landscape.man_made",
                        "elementType": "geometry.stroke",
                        "stylers": [
                            {
                                "color": "#334e87"
                            }
                        ]
                    },
                    {
                        "featureType": "landscape.natural",
                        "elementType": "geometry",
                        "stylers": [
                            {
                                "color": "#023e58"
                            }
                        ]
                    },
                    {
                        "featureType": "poi",
                        "elementType": "geometry",
                        "stylers": [
                            {
                                "color": "#283d6a"
                            }
                        ]
                    },
                    {
                        "featureType": "poi",
                        "elementType": "labels.text.fill",
                        "stylers": [
                            {
                                "color": "#6f9ba5"
                            }
                        ]
                    },
                    {
                        "featureType": "poi",
                        "elementType": "labels.text.stroke",
                        "stylers": [
                            {
                                "color": "#1d2c4d"
                            }
                        ]
                    },
                    {
                        "featureType": "poi.park",
                        "elementType": "geometry.fill",
                        "stylers": [
                            {
                                "color": "#023e58"
                            }
                        ]
                    },
                    {
                        "featureType": "poi.park",
                        "elementType": "labels.text.fill",
                        "stylers": [
                            {
                                "color": "#3C7680"
                            }
                        ]
                    },
                    {
                        "featureType": "road",
                        "elementType": "geometry",
                        "stylers": [
                            {
                                "color": "#304a7d"
                            }
                        ]
                    },
                    {
                        "featureType": "road",
                        "elementType": "labels.text.fill",
                        "stylers": [
                            {
                                "color": "#98a5be"
                            }
                        ]
                    },
                    {
                        "featureType": "road",
                        "elementType": "labels.text.stroke",
                        "stylers": [
                            {
                                "color": "#1d2c4d"
                            }
                        ]
                    },
                    {
                        "featureType": "road.arterial",
                        "stylers": [
                            {
                                "visibility": "off"
                            }
                        ]
                    },
                    {
                        "featureType": "road.highway",
                        "elementType": "geometry",
                        "stylers": [
                            {
                                "color": "#2c6675"
                            }
                        ]
                    },
                    {
                        "featureType": "road.highway",
                        "elementType": "geometry.stroke",
                        "stylers": [
                            {
                                "color": "#255763"
                            }
                        ]
                    },
                    {
                        "featureType": "road.highway",
                        "elementType": "labels",
                        "stylers": [
                            {
                                "visibility": "off"
                            }
                        ]
                    },
                    {
                        "featureType": "road.highway",
                        "elementType": "labels.text.fill",
                        "stylers": [
                            {
                                "color": "#b0d5ce"
                            }
                        ]
                    },
                    {
                        "featureType": "road.highway",
                        "elementType": "labels.text.stroke",
                        "stylers": [
                            {
                                "color": "#023e58"
                            }
                        ]
                    },
                    {
                        "featureType": "road.local",
                        "stylers": [
                            {
                                "visibility": "off"
                            }
                        ]
                    },
                    {
                        "featureType": "transit",
                        "elementType": "labels.text.fill",
                        "stylers": [
                            {
                                "color": "#98a5be"
                            }
                        ]
                    },
                    {
                        "featureType": "transit",
                        "elementType": "labels.text.stroke",
                        "stylers": [
                            {
                                "color": "#1d2c4d"
                            }
                        ]
                    },
                    {
                        "featureType": "transit.line",
                        "elementType": "geometry.fill",
                        "stylers": [
                            {
                                "color": "#283d6a"
                            }
                        ]
                    },
                    {
                        "featureType": "transit.station",
                        "elementType": "geometry",
                        "stylers": [
                            {
                                "color": "#3a4762"
                            }
                        ]
                    },
                    {
                        "featureType": "water",
                        "elementType": "geometry",
                        "stylers": [
                            {
                                "color": "#0e1626"
                            }
                        ]
                    },
                    {
                        "featureType": "water",
                        "elementType": "labels.text.fill",
                        "stylers": [
                            {
                                "color": "#4e6d70"
                            }
                        ]
                    }
                ],
                streetViewControl: false, // Disable Street View button
                mapTypeId: 'terrain' // Set default layer to terrain
            });

            // Add loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading';
            loadingDiv.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:#fff;padding:20px 30px;border-radius:8px;font-family:sans-serif;z-index:1000;';
            loadingDiv.textContent = 'Loading wildfire data...';
            document.body.appendChild(loadingDiv);

            // Fetch the GeoJSON data with error handling
            fetch('https://us-central1-sf-live-charts.cloudfunctions.net/serveNIFCGeojson')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to load fire data: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    map.data.addGeoJson(data);
                    document.body.removeChild(loadingDiv);
                    
                    // Show last updated timestamp
                    const updateDiv = document.createElement('div');
                    updateDiv.id = 'last-update';
                    updateDiv.style.cssText = 'position:absolute;bottom:10px;left:10px;background:rgba(0,0,0,0.7);color:#fff;padding:8px 12px;border-radius:4px;font-size:12px;font-family:sans-serif;z-index:999;';
                    updateDiv.textContent = `Data updated: ${new Date().toLocaleString()}`;
                    document.body.appendChild(updateDiv);
                })
                .catch(error => {
                    console.error('Error loading wildfire data:', error);
                    loadingDiv.textContent = '⚠️ Unable to load wildfire data. Please refresh the page.';
                    loadingDiv.style.background = 'rgba(207,66,54,0.9)'; // SF Examiner red
                });

            // Style the GeoJSON data
            map.data.setStyle({
                fillColor: 'rgba(255,165,0,0.6)', 
                strokeColor: 'rgba(255,165,0,0.9)', 
                strokeWeight: 1
            });

            // Limit the map's viewport to California's borders
            const strictBounds = new google.maps.LatLngBounds(
                new google.maps.LatLng(32.5343, -124.4096),
                new google.maps.LatLng(42.0095, -114.1308)
            );

            google.maps.event.addListener(map, 'dragend', function() {
                if (strictBounds.contains(map.getCenter())) return;

                const c = map.getCenter(),
                    x = c.lng(),
                    y = c.lat(),
                    maxX = strictBounds.getNorthEast().lng(),
                    maxY = strictBounds.getNorthEast().lat(),
                    minX = strictBounds.getSouthWest().lng(),
                    minY = strictBounds.getSouthWest().lat();

                let newX = x,
                    newY = y;

                if (x < minX) newX = minX;
                if (x > maxX) newX = maxX;
                if (y < minY) newY = minY;
                if (y > maxY) newY = maxY;

                map.setCenter(new google.maps.LatLng(newY, newX));
            });

            const hoverInfoWindow = new google.maps.InfoWindow({
                pixelOffset: new google.maps.Size(0, -30), // Adjust info window position
                maxWidth: 150,
                disableAutoPan: true, // Prevent auto panning on hover
                zIndex: 1 // Ensure the hover info window is below the click info window
            });

            map.data.addListener('mouseover', function(event) {
                const incidentName = event.feature.getProperty('poly_IncidentName');
                const contentString = `<strong>${incidentName} Fire</strong>`;
                hoverInfoWindow.setContent(contentString);
                hoverInfoWindow.setPosition(event.latLng);
                hoverInfoWindow.open(map);
            });

            const clickInfoWindow = new google.maps.InfoWindow({
                pixelOffset: new google.maps.Size(0, -30), // Adjust info window position
                zIndex: 2, // Ensure the click info window is above the hover info window
                maxWidth: isMobile ? 150 : 200, // Adjust width for mobile
                enableEventPropagation: true // Allow map interaction
            });

            map.data.addListener('click', function(event) {
                console.log('Feature properties:');
                event.feature.forEachProperty(function(value, name) {
                    console.log(name + ': ' + value);
                });

                const polyName = event.feature.getProperty('poly_IncidentName');
                const attrName = event.feature.getProperty('attr_IncidentName');
                
                // Get the acreage value and check its type
                const acresRaw = event.feature.getProperty('poly_GISAcres');
                let acres = 'N/A'; // Default value if parsing fails
                
                if (acresRaw) {
                    const acresParsed = parseFloat(acresRaw);
                    if (!isNaN(acresParsed)) {
                        acres = Math.round(acresParsed).toLocaleString(); // Round to nearest whole number and format
                    }
                }

                console.log('Acreage raw value:', acresRaw); // Debugging: check the raw value
                console.log('Acreage formatted:', acres); // Debugging: check the formatted value

                const percentContained = event.feature.getProperty('attr_PercentContained');
                const cause = event.feature.getProperty('attr_FireCause');
                const description = event.feature.getProperty('attr_IncidentShortDescription');

                let contentString = `<strong>${polyName} Fire</strong><br>`;
                if (polyName.toLowerCase() !== attrName.toLowerCase()) {
                    contentString += `... part of the ${attrName}.<br>`;
                }
                contentString += `${acres} acres burned.<br>`;
                contentString += `${percentContained}% contained.<br>`;
                contentString += `Cause: ${cause}<br>`;
                contentString += `${description}`;

                clickInfoWindow.setContent(contentString);
                clickInfoWindow.setPosition(event.latLng);
                clickInfoWindow.open(map);
            });
        }
    </script>
</body>

</html>
