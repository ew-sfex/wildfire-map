<script>
    function initMap() {
        const isMobile = window.innerWidth <= 480;

        const map = new google.maps.Map(document.getElementById('map'), {
            zoom: isMobile ? 5 : 6, // Adjust zoom for mobile
            center: {
                lat: 36.7783,
                lng: -119.4179
            },
            styles: [
                // Your existing styles
            ],
            streetViewControl: false, // Disable Street View button
            mapTypeId: 'terrain' // Set default layer to terrain
        });

        // Fetch the GeoJSON data from the Cloud Function
        map.data.loadGeoJson('https://us-central1-sf-live-charts.cloudfunctions.net/serveNIFCGeojson');

        // Style the GeoJSON data
        map.data.setStyle({
            fillColor: 'rgba(255,165,0,0.6)', 
            strokeColor: 'rgba(255,165,0,0.9)', 
            strokeWeight: 1
        });

        // Limit the map's viewport to California's borders
        const strictBounds = new google.maps.LatLngBounds(
            new google.maps.LatLng(32.5343, -124.4096),
            new google.maps.LatLng(42.0095, -114.1308)
        );

        google.maps.event.addListener(map, 'dragend', function() {
            if (strictBounds.contains(map.getCenter())) return;

            const c = map.getCenter(),
                x = c.lng(),
                y = c.lat(),
                maxX = strictBounds.getNorthEast().lng(),
                maxY = strictBounds.getNorthEast().lat(),
                minX = strictBounds.getSouthWest().lng(),
                minY = strictBounds.getSouthWest().lat();

            let newX = x,
                newY = y;

            if (x < minX) newX = minX;
            if (x > maxX) newX = maxX;
            if (y < minY) newY = minY;
            if (y > maxY) newY = maxY;

            map.setCenter(new google.maps.LatLng(newY, newX));
        });

        const infoWindow = new google.maps.InfoWindow({
            pixelOffset: new google.maps.Size(0, -30) // Adjust info window position
        });

        // Adjust font size for mobile
        if (isMobile) {
            infoWindow.setOptions({
                maxWidth: 150,
                fontSize: '14px'
            });
        }

        map.data.addListener('mouseover', function(event) {
            const incidentName = event.feature.getProperty('poly_IncidentName');
            const contentString = `<strong>${incidentName} Fire</strong>`;
            infoWindow.setContent(contentString);
            infoWindow.setPosition(event.latLng);
            infoWindow.open(map);
        });

        map.data.addListener('click', function(event) {
            const polyName = event.feature.getProperty('poly_IncidentName');
            const attrName = event.feature.getProperty('attr_IncidentName');
            const acres = Math.round(event.feature.getProperty('poly_GISAcres')).toLocaleString(); // Add comma separator
            const percentContained = event.feature.getProperty('attr_PercentContained');
            const cause = event.feature.getProperty('attr_FireCause');
            const description = event.feature.getProperty('attr_IncidentShortDescription');

            let contentString = `<strong>${polyName} Fire</strong><br>`;
            if (polyName.toLowerCase() !== attrName.toLowerCase()) {
                contentString += `... part of the ${attrName}.<br>`;
            }
            contentString += `${acres} acres burned.<br>`;
            contentString += `${percentContained}% contained.<br>`;
            contentString += `Cause: ${cause}<br>`;
            contentString += `${description}`;

            infoWindow.setContent(contentString);
            infoWindow.setPosition(event.latLng);
            infoWindow.open(map);
        });
    }
</script>
